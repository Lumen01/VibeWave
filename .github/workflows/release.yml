name: Build and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ github.run_number }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract Version and Tag Message
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            # ËØªÂèñÊ†áÁ≠æÈôÑÊ≥®Ê∂àÊÅØ
            TAG_MESSAGE=$(git tag -l --format='%(contents)' ${GITHUB_REF#refs/tags/} 2>/dev/null || echo "")
          else
            git fetch --tags
            LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION=${LATEST#v}
            TAG_MESSAGE=""
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          # Â§ÑÁêÜÂ§öË°åÊ∂àÊÅØËæìÂá∫
          echo "tag_message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"
      
      - name: Save Version
        run: echo "${{ steps.version.outputs.version }}" > .version
      
      - name: Build
        run: |
          chmod +x run-app.sh
          ./run-app.sh --build
          ls -la .build/debug/

      - name: Smoke Test Launch
        run: |
          APP_BIN=".build/debug/VibeWave.app/Contents/MacOS/VibeWave"
          LOG_FILE="$(mktemp)"

          "$APP_BIN" > "$LOG_FILE" 2>&1 &
          APP_PID=$!
          sleep 3

          if ! kill -0 "$APP_PID" 2>/dev/null; then
            echo "ERROR: App exited unexpectedly during smoke test"
            cat "$LOG_FILE"
            exit 1
          fi

          kill "$APP_PID" 2>/dev/null || true
          wait "$APP_PID" 2>/dev/null || true

          if grep -q "could not load resource bundle" "$LOG_FILE"; then
            echo "ERROR: Resource bundle lookup failed"
            cat "$LOG_FILE"
            exit 1
          fi
      
      - name: Package
        run: |
          APP_PATH=".build/debug/VibeWave.app"
          if [ -d "$APP_PATH" ]; then
            ditto -c -k --keepParent "$APP_PATH" "VibeWave-${{ steps.version.outputs.version }}.zip"
            ls -la VibeWave-*.zip
          else
            echo "ERROR: App bundle not found at $APP_PATH"
            exit 1
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VibeWave-${{ steps.version.outputs.version }}
          path: VibeWave-${{ steps.version.outputs.version }}.zip
      
      - name: Create Release
        if: github.ref_type == 'tag'
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          RELEASE_NOTES=$(cat << 'EOF'
          ## VibeWave ${{ steps.version.outputs.version }} (Build ${{ github.run_number }})

          ${{ steps.version.outputs.tag_message }}

          ---

          ### Download
          - üì¶ [VibeWave-${{ steps.version.outputs.version }}.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/VibeWave-${{ steps.version.outputs.version }}.zip)

          ### Install
          1. Download and extract ZIP
          2. Drag VibeWave.app to Applications folder
          3. First launch may require right-click and "Open"
          EOF
          )
          
          # Check if release exists, edit it; otherwise create new
          if gh release view "$TAG" &>/dev/null; then
            gh release edit "$TAG" --title "VibeWave ${{ steps.version.outputs.version }}" --notes "$RELEASE_NOTES"
          else
            gh release create "$TAG" --title "VibeWave ${{ steps.version.outputs.version }}" --notes "$RELEASE_NOTES"
          fi
          
          # Upload asset (overwrite if exists)
          gh release upload "$TAG" "VibeWave-${{ steps.version.outputs.version }}.zip" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
