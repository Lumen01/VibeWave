name: Build and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ github.run_number }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract Version and Tag Message
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            # è¯»å–æ ‡ç­¾é™„æ³¨æ¶ˆæ¯
            TAG_MESSAGE=$(git tag -l --format='%(contents)' ${GITHUB_REF#refs/tags/} 2>/dev/null || echo "")
          else
            git fetch --tags
            LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            VERSION=${LATEST#v}
            TAG_MESSAGE=""
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          # å¤„ç†å¤šè¡Œæ¶ˆæ¯è¾“å‡º
          echo "tag_message<<EOF" >> $GITHUB_OUTPUT
          echo "$TAG_MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: $VERSION"
      
      - name: Save Version
        run: echo "${{ steps.version.outputs.version }}" > .version
      
      - name: Build
        run: |
          chmod +x run-app.sh
          ./run-app.sh --build
          ls -la .build/debug/
      
      - name: Package
        run: |
          APP_PATH=".build/debug/VibeWave.app"
          if [ -d "$APP_PATH" ]; then
            ditto -c -k --keepParent "$APP_PATH" "VibeWave-${{ steps.version.outputs.version }}.zip"
            ls -la VibeWave-*.zip
          else
            echo "ERROR: App bundle not found at $APP_PATH"
            exit 1
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VibeWave-${{ steps.version.outputs.version }}
          path: VibeWave-${{ steps.version.outputs.version }}.zip
      
      - name: Create Release
        if: github.ref_type == 'tag'
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "VibeWave ${{ steps.version.outputs.version }}" \
            --notes-file - << 'EOF'
          ## VibeWave ${{ steps.version.outputs.version }} (Build ${{ github.run_number }})

          ${{ steps.version.outputs.tag_message }}

          ---

          ### Download
          - ğŸ“¦ [VibeWave-${{ steps.version.outputs.version }}.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/VibeWave-${{ steps.version.outputs.version }}.zip)

          ### Install
          1. Download and extract ZIP
          2. Drag VibeWave.app to Applications folder
          3. First launch may require right-click and "Open"
          EOF
          
          # Upload asset
          gh release upload "v${{ steps.version.outputs.version }}" "VibeWave-${{ steps.version.outputs.version }}.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
