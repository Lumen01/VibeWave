name: Build and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ github.run_number }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      
      - name: Extract Version and Tag Context
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG_NAME#v}"
          else
            git fetch --tags --force
            TAG_NAME="$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")"
            VERSION="${TAG_NAME#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "ðŸ“¦ Building version: $VERSION from tag: $TAG_NAME"
      
      - name: Save Version
        run: echo "${{ steps.version.outputs.version }}" > .version
      
      - name: Build
        run: |
          chmod +x run-app.sh
          ./run-app.sh --build
          ls -la .build/debug/

      - name: Smoke Test Launch
        run: |
          APP_BIN=".build/debug/VibeWave.app/Contents/MacOS/VibeWave"
          LOG_FILE="$(mktemp)"

          "$APP_BIN" > "$LOG_FILE" 2>&1 &
          APP_PID=$!
          sleep 3

          if ! kill -0 "$APP_PID" 2>/dev/null; then
            echo "ERROR: App exited unexpectedly during smoke test"
            cat "$LOG_FILE"
            exit 1
          fi

          kill "$APP_PID" 2>/dev/null || true
          wait "$APP_PID" 2>/dev/null || true

          if grep -q "could not load resource bundle" "$LOG_FILE"; then
            echo "ERROR: Resource bundle lookup failed"
            cat "$LOG_FILE"
            exit 1
          fi
      
      - name: Package
        run: |
          APP_PATH=".build/debug/VibeWave.app"
          if [ -d "$APP_PATH" ]; then
            ditto -c -k --keepParent "$APP_PATH" "VibeWave-${{ steps.version.outputs.version }}.zip"
            ls -la VibeWave-*.zip
          else
            echo "ERROR: App bundle not found at $APP_PATH"
            exit 1
          fi
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VibeWave-${{ steps.version.outputs.version }}
          path: VibeWave-${{ steps.version.outputs.version }}.zip
      
      - name: Create Release
        if: github.ref_type == 'tag'
        run: |
          TAG="${{ steps.version.outputs.tag_name }}"
          VERSION="${{ steps.version.outputs.version }}"

          TAG_MESSAGE="$(git for-each-ref "refs/tags/$TAG" --format='%(contents)' 2>/dev/null || true)"
          if [[ -z "${TAG_MESSAGE// /}" ]]; then
            TAG_MESSAGE="No annotated tag notes found for $TAG."
          fi

          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          if [[ -n "$PREV_TAG" ]]; then
            CHANGE_RANGE="${PREV_TAG}..${TAG}"
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' "$CHANGE_RANGE")"
          else
            CHANGE_RANGE="$TAG"
            CHANGES="$(git log --no-merges --pretty='- %s (%h)' "$TAG")"
          fi

          if [[ -z "${CHANGES// /}" ]]; then
            CHANGES="- No commit-level changes detected."
          fi

          cat > RELEASE_NOTES.md <<EOF
          ## VibeWave ${VERSION} (Build ${{ github.run_number }})

          ### Release Notes
          ${TAG_MESSAGE}

          ---

          ### Changes (${CHANGE_RANGE})
          ${CHANGES}

          ---

          ### Download
          - ðŸ“¦ [VibeWave-${VERSION}.zip](https://github.com/${{ github.repository }}/releases/download/${TAG}/VibeWave-${VERSION}.zip)

          ### Install
          1. Download and extract ZIP
          2. Drag VibeWave.app to Applications folder
          3. First launch may require right-click and "Open"
          EOF
          
          # Check if release exists, edit it; otherwise create new
          if gh release view "$TAG" &>/dev/null; then
            gh release edit "$TAG" --title "VibeWave ${VERSION}" --notes-file RELEASE_NOTES.md
          else
            gh release create "$TAG" --title "VibeWave ${VERSION}" --notes-file RELEASE_NOTES.md
          fi
          
          # Upload asset (overwrite if exists)
          gh release upload "$TAG" "VibeWave-${VERSION}.zip" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
